name: build-and-deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  NODE_OPTIONS: "--max-old-space-size=4096"

concurrency:
  group: briko-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Prep pnpm store cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpmstore-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpmstore-

      - name: Install deps (offline if cache hit)
        run: |
          set -euxo pipefail
          pnpm config set store-dir ~/.pnpm-store
          pnpm fetch --frozen-lockfile || true
          pnpm install --frozen-lockfile --offline || pnpm install --frozen-lockfile

      # ---- BUILD ----
      - name: Build (Nuxt static)
        env:
          NUXT_TELEMETRY_DISABLED: 1
        run: |
          set -euxo pipefail
          time pnpm exec nuxi generate

      - name: Verify output exists
        run: |
          test -f .output/public/index.html || (echo "index.html missing" && exit 1)
          du -h -d1 .output | sort -h | tail -n 20

      # ---- MEASURE ----
      - name: Inspect output size (top files)
        run: |
          find .output/public -type f -printf '%s %p\n' | sort -nr | head -n 40 | awk '{printf "%8.1f MB  %s\n", $1/1024/1024, $2}'

      # ---- GUARDRAILS ----
      - name: Artifact size guard
        run: bash scripts/guard-artifacts.sh

      # ---- VERIFY ----
      - name: Verify output exists
        run: test -d .output/public && ls -la .output/public | head -n 50

      # -------------------------
      # SWA CLI uploader (fast)
      # -------------------------
      - name: Deploy via SWA CLI
        run: |
          set -euxo pipefail
          npm i -g @azure/static-web-apps-cli
          swa deploy .output/public --env production --verbose
        env:
          SWA_CLI_DEPLOYMENT_TOKEN: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}

      # (Removed Azure action deploy step in favor of SWA CLI)
